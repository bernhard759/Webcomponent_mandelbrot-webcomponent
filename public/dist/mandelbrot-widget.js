(()=>{var t={m:{},u:t=>t+".mandelbrot-widget.js"};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),t.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var n=t.g.document;if(!e&&n&&(n.currentScript&&(e=n.currentScript.src),!e)){var a=n.getElementsByTagName("script");if(a.length)for(var s=a.length-1;s>-1&&!e;)e=a[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})(),t.b=document.baseURI||self.location.href;class e extends HTMLElement{static observedAttributes=[];constructor(){super();const t=this.attachShadow({mode:"open"}),e=document.createElement("template");e.innerHTML='\n            <div class="canvas-container">\n                <canvas id="mandelbrot-canvas"></canvas>\n                <div class="canvas-controls">\n                    <span class="plus" title="Zoom in">+</span>\n                    <span class="center" title="Center">&#9678;</span>\n                    <span class="minus" title="Zoom out">&minus;</span>\n                    <span class="larr" title="Move left">&larr;</span>\n                    <span class="uarr" title="Move up">&uarr;</span>\n                    <span class="darr" title="Move down">&darr;</span>\n                    <span class="rarr" title="Move right">&rarr;</span>\n                    <span class="download" title="Download image">&#10515;</span>\n                    <span class="fullscreen" title="Fullscreen">&#9974;</span>\n                </div>\n                <div class="contextmenu">\n                    <button>Switch z</button>\n                </div>\n            </div>',t.appendChild(e.content.cloneNode(!0));const n=document.createElement("style");console.log(n.isConnected),n.textContent=`\n      .canvas-container {\n      position: relative;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      overflow: hidden;\n      ${this.getAttribute("width")?`max-width: ${this.getAttribute("width")}px`:""};\n      min-width: 250px;\n      margin: 0 auto;\n      width: 100%;\n      border-radius: 1em;\n      aspect-ratio: 3/2;\n      }\n\n      .canvas-container:fullscreen {\n      background-color: hsl(0, 0%, 15%) !important;\n      }\n\n      .canvas-container:fullscreen canvas {\n      width: calc((3 / 2) * 100vh);\n      }\n\n      canvas {\n      width: 100%;\n      background-color: rgba(0, 0, 0, 0.05);\n      }\n\n      canvas.panning {\n      cursor: all-scroll;\n      }\n\n      .canvas-container .contextmenu {\n      position: absolute;\n      visibility: hidden;\n      overflow-wrap: break-word;\n      max-width: 150px;\n      }\n\n      .canvas-container .contextmenu.show {\n      visibility: visible;\n      }\n\n      .contextmenu button {\n      all: unset;\n      background: rgba(155, 155, 155, 0.5);\n      font-size: 0.85rem;\n      color: white;\n      padding: 0.5em 1em;\n      border-radius: 0.5em;\n      cursor: pointer;\n      }\n\n      .contextmenu button:hover {\n      background: rgba(155, 155, 155, 0.8) !important;\n      }\n\n      .canvas-controls {\n      color: rgba(255, 255, 255, 0.6);\n      display: flex;\n      justify-content: flex-end;\n      align-items: center;\n      gap: 0.5rem;\n      position: absolute;\n      padding-block: 4px;\n      padding-inline: 8px;\n      font-size: 150%;\n      bottom: 0;\n      right: 0;\n      border-radius: 6px;\n      }\n      .canvas-controls * {\n      cursor: pointer;\n      }\n\n      .canvas-controls *:hover {\n      color: rgba(255, 255, 255, 0.8);\n      }\n\n      .canvas-controls:hover {\n      background: linear-gradient(rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.1));\n      }`,t.appendChild(n)}connectedCallback(){const e=this.shadowRoot;{let n=[-2,1],a=[1,-1],s=[];const i=[],o=[],r=.8;let c,l,h=!0,d={re:0,im:0},g="true"===this.getAttribute("random"),v=!1,u=navigator.hardwareConcurrency,p=new Array(u);for(let D=0;D<u;++D)p[D]=new Worker(new URL(t.p+t.u(736),t.b),{name:D});let m=S();const f=e.querySelector("#mandelbrot-canvas");let w=f.getContext("2d");function b(t){const{name:i,col:o,theSets:r}=t,c=w.createImageData(1,w.canvas.height);s.length>0&&p[i].postMessage({w:w.canvas.width,h:w.canvas.height,realSet:n,imagSet:a,isSettingUp:!1,mandel:h,point:d,iterationCount:Number(e.host.getAttribute("iterations"))||100,col:g?s.splice(Math.floor(Math.random()*s.length),1)[0]:s.shift()});for(let t=0;t<4*w.canvas.height;t++){const e=r[Math.floor(t/4)];t%4==0&&(c.data[t+0]=m[e.in?0:e.iterations%m.length][0],c.data[t+1]=m[e.in?0:e.iterations%m.length][1],c.data[t+2]=m[e.in?0:e.iterations%m.length][2],c.data[t+3]=255)}w.putImageData(c,o,0)}w.canvas.width=f.offsetWidth/1,w.canvas.height=w.canvas.width*(2/3),k(w,y,p),w.createImageData(1,w.canvas.height),L(p);const x=e.querySelector(".contextmenu button");function L(t){t[0].postMessage({w:w.canvas.width,h:w.canvas.height,realSet:n,imagSet:a,isSettingUp:!0,mandel:h,point:d,iterationCount:Number(e.host.getAttribute("iterations"))||100}),t.forEach((t=>{t.addEventListener("message",(function(t){b(t.data)}))})),y(t)}function y(t){for(let t=0;t<w.canvas.width;t++)s[t]=t;t.forEach(((t,i)=>{t.postMessage({w:w.canvas.width,h:w.canvas.height,realSet:n,imagSet:a,isSettingUp:!1,mandel:h,point:d,iterationCount:Number(e.host.getAttribute("iterations"))||100,col:g?s.splice(Math.floor(Math.random()*s.length),1)[0]:s.shift()})}))}function k(t,e,n){s=[];new ResizeObserver(function(t,e){let n=!1;return(...a)=>{n||(t(...a),n=!0,setTimeout((()=>{n=!1}),e))}}((a=>{a.forEach((a=>{const s=t.canvas.toDataURL("image/png");var i=new Image;i.addEventListener("load",(function(){t.drawImage(i,0,0,t.canvas.width,t.canvas.height)})),i.src=s,t.canvas.width=a.target.offsetWidth/1,t.canvas.height=t.canvas.width*(2/3),e(n)}))}),250)).observe(t.canvas)}function E(t,e,n){return n[0]+t/e*(n[1]-n[0])}function M(t){e.fullscreenElement?e.fullscreenElement&&document.exitFullscreen():t.requestFullscreen()}function S(){let t,n,a,s;switch(e.host.getAttribute("palette")){case"grayscale":n=[211,211,211],a=[2*n[0]/3,2*n[1]/3,2*n[2]/3],s=[n[0]/3,n[1]/3,n[2]/3];break;case"colorful":default:n=[165,42,42],a=[70,130,180],s=[152,251,152];break;case"blue":n=[30,144,255],a=[2*n[0]/3,2*n[1]/3,2*n[2]/3],s=[n[0]/3,n[1]/3,n[2]/3]}function i(e){return function(t,e,n){let a=Math.floor((e.r-t.r)*n+t.r),s=Math.floor((e.g-t.g)*n+t.g),i=Math.floor((e.b-t.b)*n+t.b);return[a,s,i]}(t[Math.floor(e)],t[Math.floor(e)+1],e%1)}return t=[{r:n[0],g:n[1],b:n[2]},{r:a[0],g:a[1],b:a[2]},{r:s[0],g:s[1],b:s[2]}],new Array(16).fill(0).map(((e,n)=>0===n?[0,0,0]:i(n/16*(t.length-1))))}x.addEventListener("click",(t=>{h=!h,t.target.closest(".contextmenu").classList.remove("show"),y(p)})),f.oncontextmenu=function(t){if(t.preventDefault(),t.stopPropagation(),!e.host.getAttribute("julia")||"false"===e.host.getAttribute("julia"))return;const s=f.getBoundingClientRect(),i=t.clientX-s.left,o=t.clientY-s.top;d.re=E(i,w.canvas.width,n),d.im=E(o,w.canvas.height,a),x.innerHTML=`Switch to ${h?"Julia":"Mandelbrot"} set ${h?`at point z = ${E(i,w.canvas.width,n).toFixed(1)} ${E(o,w.canvas.height,a)<0?E(o,w.canvas.height,a).toFixed(1):"+ "+E(o,w.canvas.height,a).toFixed(1)}&nbsp;i`:""}`,MathJax.typeset(),console.log(t),console.log(t);const r=e.querySelector(".contextmenu");r.classList.add("show"),r.style.left=`${s.right<t.clientX+r.offsetWidth?i-15-r.offsetWidth:i+15}px`,r.style.top=`${s.top+s.height<t.clientY+r.offsetHeight?o-15-r.offsetHeight:o+15}px`},w.canvas.addEventListener("mousedown",(t=>{e.querySelector(".contextmenu").classList.remove("show"),t.preventDefault(),t.stopPropagation(),c=t.screenX-w.canvas.offsetLeft,l=t.screenY-w.canvas.offsetTop,v=!0,t.ctrlKey&&f.classList.add("panning")})),w.canvas.addEventListener("mouseup",(t=>{t.preventDefault(),t.stopPropagation(),v=!1,f.classList.remove("panning")})),w.canvas.addEventListener("mouseout",(t=>{t.preventDefault(),t.stopPropagation(),v=!1,f.classList.remove("panning")})),w.canvas.addEventListener("mousemove",(t=>{if(t.preventDefault(),t.stopPropagation(),!v||!t.ctrlKey)return;const e=t.screenX-w.canvas.offsetLeft,s=t.screenY-w.canvas.offsetTop;let i=e-c,o=s-l;c=e,l=s;const r=w.canvas.toDataURL("image/png");var h=new Image;h.addEventListener("load",(function(){w.drawImage(h,i,o)})),h.src=r;const d=[E(-i,w.canvas.width,n),E(w.canvas.width-i,w.canvas.width,n)],g=[E(-o,w.canvas.height,a),E(w.canvas.height-o,w.canvas.height,a)];n=d,a=g,y(p)})),f.addEventListener("wheel",(t=>{e.querySelector(".contextmenu").classList.remove("show"),t.preventDefault(),t.stopPropagation();const s=f.getBoundingClientRect(),c=t.clientX-s.left,l=t.clientY-s.top,h=t.wheelDelta>0?r:1/r,d=c*h,g=(w.canvas.width-c)*h,v=l*h,u=(w.canvas.height-l)*h,m=[E(c-d,w.canvas.width,n),E(c+g,w.canvas.width,n)],b=[E(l-v,w.canvas.height,a),E(l+u,w.canvas.height,a)];if(n=m,a=b,t.wheelDelta>0){i.push(w.getImageData(0,0,f.width,f.height));const t=w.canvas.toDataURL("image/png");var x=new Image;x.addEventListener("load",(function(){w.drawImage(x,2*d/w.canvas.width*(1/h)/2*(w.canvas.width*(1/h)-w.canvas.width)*-1,2*v/w.canvas.height*(1/h)/2*(w.canvas.height*(1/h)-w.canvas.height)*-1,w.canvas.width/h,w.canvas.height/h),o.push(w.canvas.toDataURL("image/png"))})),x.src=t}y(p)})),e.querySelector(".canvas-controls").addEventListener("click",(t=>{const e=Math.abs(n[1]-n[0]),s=Math.abs(a[1]-a[0]);switch(t.target.className){case"plus":{const t=r,e=[E(w.canvas.width/2-f.width*t/2,w.canvas.width,n),E(w.canvas.width/2+f.width*t/2,w.canvas.width,n)],s=[E(f.height/2-f.height*t/2,w.canvas.height,a),E(f.height/2+f.height*t/2,w.canvas.height,a)];n=e,a=s,i.push(w.getImageData(0,0,f.width,f.height));const l=w.canvas.toDataURL("image/png");var c=new Image;c.addEventListener("load",(function(){w.drawImage(c,-(w.canvas.width/t-w.canvas.width)/2,-(w.canvas.height/t-w.canvas.height)/2,w.canvas.width/t,w.canvas.height/t),o.push(w.canvas.toDataURL("image/png"))})),c.src=l}break;case"center":n=[-2,1],a=[1,-1];break;case"minus":{const t=1/r,e=[E(w.canvas.width/2-f.width*t/2,w.canvas.width,n),E(w.canvas.width/2+f.width*t/2,w.canvas.width,n)],s=[E(f.height/2-f.height*t/2,w.canvas.height,a),E(f.height/2+f.height*t/2,w.canvas.height,a)];n=e,a=s}break;case"larr":n[0]-=.05*e,n[1]-=.05*e;break;case"uarr":a[0]+=.05*s,a[1]+=.05*s;break;case"darr":a[0]-=.05*s,a[1]-=.05*s;break;case"rarr":n[0]+=.05*e,n[1]+=.05*e;break;case"download":let l=document.createElement("a");l.download=h?"mandelbrot.png":"julia.png",l.href=w.canvas.toDataURL(),l.click();break;case"fullscreen":return void M(t.target.closest(".canvas-container"));default:return}y(p)}))}}disconnectedCallback(){}adoptedCallback(){}attributeChangedCallback(t,e,n){}}customElements.define("mandelbrot-widget",e)})();