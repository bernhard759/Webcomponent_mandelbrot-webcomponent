(()=>{class t extends HTMLElement{static observedAttributes=[];constructor(){super();const t=this.attachShadow({mode:"open"}),e=document.createElement("template");e.innerHTML='\n            <div class="canvas-container">\n                <canvas id="mandelbrot-canvas"></canvas>\n                <div class="canvas-controls">\n                    <span class="plus" title="Zoom in">+</span>\n                    <span class="center" title="Center">&#9678;</span>\n                    <span class="minus" title="Zoom out">&minus;</span>\n                    <span class="larr" title="Move left">&larr;</span>\n                    <span class="uarr" title="Move up">&uarr;</span>\n                    <span class="darr" title="Move down">&darr;</span>\n                    <span class="rarr" title="Move right">&rarr;</span>\n                    <span class="download" title="Download image">&#10515;</span>\n                    <span class="fullscreen" title="Fullscreen">&#9974;</span>\n                </div>\n                <div class="contextmenu">\n                    <button>Switch z</button>\n                </div>\n            </div>',t.appendChild(e.content.cloneNode(!0));const n=document.createElement("style");console.log(n.isConnected),n.textContent=`\n      .canvas-container {\n      position: relative;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      overflow: hidden;\n      ${this.getAttribute("width")?`max-width: ${this.getAttribute("width")}px`:""};\n      min-width: 250px;\n      margin: 0 auto;\n      width: 100%;\n      border-radius: 1em;\n      aspect-ratio: 3/2;\n      }\n\n      .canvas-container:fullscreen {\n      background-color: hsl(0, 0%, 15%) !important;\n      }\n\n      .canvas-container:fullscreen canvas {\n      width: calc((3 / 2) * 100vh);\n      }\n\n      canvas {\n      width: 100%;\n      background-color: rgba(0, 0, 0, 0.05);\n      }\n\n      canvas.panning {\n      cursor: all-scroll;\n      }\n\n      .canvas-container .contextmenu {\n      position: absolute;\n      visibility: hidden;\n      overflow-wrap: break-word;\n      max-width: 150px;\n      }\n\n      .canvas-container .contextmenu.show {\n      visibility: visible;\n      }\n\n      .contextmenu button {\n      all: unset;\n      background: rgba(155, 155, 155, 0.5);\n      font-size: 0.85rem;\n      color: white;\n      padding: 0.5em 1em;\n      border-radius: 0.5em;\n      cursor: pointer;\n      }\n\n      .contextmenu button:hover {\n      background: rgba(155, 155, 155, 0.8) !important;\n      }\n\n      .canvas-controls {\n      color: rgba(255, 255, 255, 0.6);\n      display: flex;\n      justify-content: flex-end;\n      align-items: center;\n      gap: 0.5rem;\n      position: absolute;\n      padding-block: 4px;\n      padding-inline: 8px;\n      font-size: 150%;\n      bottom: 0;\n      right: 0;\n      border-radius: 6px;\n      }\n      .canvas-controls * {\n      cursor: pointer;\n      }\n\n      .canvas-controls *:hover {\n      color: rgba(255, 255, 255, 0.8);\n      }\n\n      .canvas-controls:hover {\n      background: linear-gradient(rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.1));\n      }`,t.appendChild(n)}connectedCallback(){const t=this.shadowRoot;{let n=[-2,1],a=[1,-1],s=[];const i=[],o=[],r=.8;let c,l,h=!0,d={re:0,im:0},g="true"===this.getAttribute("random"),v=!1,u=navigator.hardwareConcurrency,p=new Array(u);for(let D=0;D<u;++D){var e=URL.createObjectURL(new Blob(["(",function(){let t,e,n,a,s,i,o;function r(o,r){return{re:o=n[0]+o/t*s,im:r=a[0]+r/e*i}}function c(t){let e,n,a={re:0,im:0},s=0;do{e={re:Math.pow(a.re,2)-Math.pow(a.im,2),im:2*a.re*a.im},a={re:e.re+t.re,im:e.im+t.im},n=Math.sqrt(Math.pow(a.re,2)+Math.pow(a.im,2)),s+=1}while(n<=2&&s<o);return{iterations:s,in:n<=2}}function l(t,e){let n,a,s=0;do{n={re:Math.pow(t.re,2)-Math.pow(t.im,2),im:2*t.re*t.im},t={re:n.re+e.re,im:n.im+e.im},a=Math.sqrt(Math.pow(t.re,2)+Math.pow(t.im,2)),s+=1}while(a<=2&&s<o);return{iterations:s,in:a<=2}}self.addEventListener("message",(function(h){const{w:d,h:g,realSet:v,imagSet:u,isSettingUp:p,mandel:m,point:f,iterationCount:w}=h.data;if(o=w,n=[v[0],v[1]],a=[u[0],u[1]],s=n[1]-n[0],i=a[1]-a[0],t=d,e=g,!p){const{col:t}=h.data,n=[];for(let a=0;a<e;a++)n[a]=m?c(r(t,a)):l(r(t,a),f);console.log("Worker "+self.name+"calculated "+t),self.postMessage({name:self.name,col:t,theSets:n})}}))}.toString(),")()"],{type:"application/javascript"}));p[D]=new Worker(e,{name:D})}let m=E();const f=t.querySelector("#mandelbrot-canvas");let w=f.getContext("2d");function b(e){const{name:i,col:o,theSets:r}=e,c=w.createImageData(1,w.canvas.height);s.length>0&&p[i].postMessage({w:w.canvas.width,h:w.canvas.height,realSet:n,imagSet:a,isSettingUp:!1,mandel:h,point:d,iterationCount:Number(t.host.getAttribute("iterations"))||100,col:g?s.splice(Math.floor(Math.random()*s.length),1)[0]:s.shift()});for(let t=0;t<4*w.canvas.height;t++){const e=r[Math.floor(t/4)];t%4==0&&(c.data[t+0]=m[e.in?0:e.iterations%m.length][0],c.data[t+1]=m[e.in?0:e.iterations%m.length][1],c.data[t+2]=m[e.in?0:e.iterations%m.length][2],c.data[t+3]=255)}w.putImageData(c,o,0)}w.canvas.width=f.offsetWidth/1,w.canvas.height=w.canvas.width*(2/3),k(w,x,p),w.createImageData(1,w.canvas.height),L(p);const M=t.querySelector(".contextmenu button");function L(e){e[0].postMessage({w:w.canvas.width,h:w.canvas.height,realSet:n,imagSet:a,isSettingUp:!0,mandel:h,point:d,iterationCount:Number(t.host.getAttribute("iterations"))||100}),e.forEach((t=>{t.addEventListener("message",(function(t){b(t.data)}))})),x(e)}function x(e){for(let t=0;t<w.canvas.width;t++)s[t]=t;e.forEach(((e,i)=>{e.postMessage({w:w.canvas.width,h:w.canvas.height,realSet:n,imagSet:a,isSettingUp:!1,mandel:h,point:d,iterationCount:Number(t.host.getAttribute("iterations"))||100,col:g?s.splice(Math.floor(Math.random()*s.length),1)[0]:s.shift()})}))}function k(t,e,n){s=[];new ResizeObserver(function(t,e){let n=!1;return(...a)=>{n||(t(...a),n=!0,setTimeout((()=>{n=!1}),e))}}((a=>{a.forEach((a=>{const s=t.canvas.toDataURL("image/png");var i=new Image;i.addEventListener("load",(function(){t.drawImage(i,0,0,t.canvas.width,t.canvas.height)})),i.src=s,t.canvas.width=a.target.offsetWidth/1,t.canvas.height=t.canvas.width*(2/3),e(n)}))}),250)).observe(t.canvas)}function S(t,e,n){return n[0]+t/e*(n[1]-n[0])}function y(e){t.fullscreenElement?t.fullscreenElement&&document.exitFullscreen():e.requestFullscreen()}function E(){let e,n,a,s;switch(t.host.getAttribute("palette")){case"grayscale":n=[211,211,211],a=[2*n[0]/3,2*n[1]/3,2*n[2]/3],s=[n[0]/3,n[1]/3,n[2]/3];break;case"colorful":default:n=[165,42,42],a=[70,130,180],s=[152,251,152];break;case"blue":n=[30,144,255],a=[2*n[0]/3,2*n[1]/3,2*n[2]/3],s=[n[0]/3,n[1]/3,n[2]/3]}function i(t){return function(t,e,n){let a=Math.floor((e.r-t.r)*n+t.r),s=Math.floor((e.g-t.g)*n+t.g),i=Math.floor((e.b-t.b)*n+t.b);return[a,s,i]}(e[Math.floor(t)],e[Math.floor(t)+1],t%1)}return e=[{r:n[0],g:n[1],b:n[2]},{r:a[0],g:a[1],b:a[2]},{r:s[0],g:s[1],b:s[2]}],new Array(16).fill(0).map(((t,n)=>0===n?[0,0,0]:i(n/16*(e.length-1))))}M.addEventListener("click",(t=>{h=!h,t.target.closest(".contextmenu").classList.remove("show"),x(p)})),f.oncontextmenu=function(e){if(e.preventDefault(),e.stopPropagation(),!t.host.getAttribute("julia")||"false"===t.host.getAttribute("julia"))return;const s=f.getBoundingClientRect(),i=e.clientX-s.left,o=e.clientY-s.top;d.re=S(i,w.canvas.width,n),d.im=S(o,w.canvas.height,a),M.innerHTML=`Switch to ${h?"Julia":"Mandelbrot"} set ${h?`at point z = ${S(i,w.canvas.width,n).toFixed(1)} ${S(o,w.canvas.height,a)<0?S(o,w.canvas.height,a).toFixed(1):"+ "+S(o,w.canvas.height,a).toFixed(1)}&nbsp;i`:""}`,MathJax.typeset(),console.log(e),console.log(e);const r=t.querySelector(".contextmenu");r.classList.add("show"),r.style.left=`${s.right<e.clientX+r.offsetWidth?i-15-r.offsetWidth:i+15}px`,r.style.top=`${s.top+s.height<e.clientY+r.offsetHeight?o-15-r.offsetHeight:o+15}px`},w.canvas.addEventListener("mousedown",(e=>{t.querySelector(".contextmenu").classList.remove("show"),e.preventDefault(),e.stopPropagation(),c=e.screenX-w.canvas.offsetLeft,l=e.screenY-w.canvas.offsetTop,v=!0,e.ctrlKey&&f.classList.add("panning")})),w.canvas.addEventListener("mouseup",(t=>{t.preventDefault(),t.stopPropagation(),v=!1,f.classList.remove("panning")})),w.canvas.addEventListener("mouseout",(t=>{t.preventDefault(),t.stopPropagation(),v=!1,f.classList.remove("panning")})),w.canvas.addEventListener("mousemove",(t=>{if(t.preventDefault(),t.stopPropagation(),!v||!t.ctrlKey)return;const e=t.screenX-w.canvas.offsetLeft,s=t.screenY-w.canvas.offsetTop;let i=e-c,o=s-l;c=e,l=s;const r=w.canvas.toDataURL("image/png");var h=new Image;h.addEventListener("load",(function(){w.drawImage(h,i,o)})),h.src=r;const d=[S(-i,w.canvas.width,n),S(w.canvas.width-i,w.canvas.width,n)],g=[S(-o,w.canvas.height,a),S(w.canvas.height-o,w.canvas.height,a)];n=d,a=g,x(p)})),f.addEventListener("wheel",(e=>{t.querySelector(".contextmenu").classList.remove("show"),e.preventDefault(),e.stopPropagation();const s=f.getBoundingClientRect(),c=e.clientX-s.left,l=e.clientY-s.top,h=e.wheelDelta>0?r:1/r,d=c*h,g=(w.canvas.width-c)*h,v=l*h,u=(w.canvas.height-l)*h,m=[S(c-d,w.canvas.width,n),S(c+g,w.canvas.width,n)],b=[S(l-v,w.canvas.height,a),S(l+u,w.canvas.height,a)];if(n=m,a=b,e.wheelDelta>0){i.push(w.getImageData(0,0,f.width,f.height));const t=w.canvas.toDataURL("image/png");var M=new Image;M.addEventListener("load",(function(){w.drawImage(M,2*d/w.canvas.width*(1/h)/2*(w.canvas.width*(1/h)-w.canvas.width)*-1,2*v/w.canvas.height*(1/h)/2*(w.canvas.height*(1/h)-w.canvas.height)*-1,w.canvas.width/h,w.canvas.height/h),o.push(w.canvas.toDataURL("image/png"))})),M.src=t}x(p)})),t.querySelector(".canvas-controls").addEventListener("click",(t=>{const e=Math.abs(n[1]-n[0]),s=Math.abs(a[1]-a[0]);switch(t.target.className){case"plus":{const t=r,e=[S(w.canvas.width/2-f.width*t/2,w.canvas.width,n),S(w.canvas.width/2+f.width*t/2,w.canvas.width,n)],s=[S(f.height/2-f.height*t/2,w.canvas.height,a),S(f.height/2+f.height*t/2,w.canvas.height,a)];n=e,a=s,i.push(w.getImageData(0,0,f.width,f.height));const l=w.canvas.toDataURL("image/png");var c=new Image;c.addEventListener("load",(function(){w.drawImage(c,-(w.canvas.width/t-w.canvas.width)/2,-(w.canvas.height/t-w.canvas.height)/2,w.canvas.width/t,w.canvas.height/t),o.push(w.canvas.toDataURL("image/png"))})),c.src=l}break;case"center":n=[-2,1],a=[1,-1];break;case"minus":{const t=1/r,e=[S(w.canvas.width/2-f.width*t/2,w.canvas.width,n),S(w.canvas.width/2+f.width*t/2,w.canvas.width,n)],s=[S(f.height/2-f.height*t/2,w.canvas.height,a),S(f.height/2+f.height*t/2,w.canvas.height,a)];n=e,a=s}break;case"larr":n[0]-=.05*e,n[1]-=.05*e;break;case"uarr":a[0]+=.05*s,a[1]+=.05*s;break;case"darr":a[0]-=.05*s,a[1]-=.05*s;break;case"rarr":n[0]+=.05*e,n[1]+=.05*e;break;case"download":let l=document.createElement("a");l.download=h?"mandelbrot.png":"julia.png",l.href=w.canvas.toDataURL(),l.click();break;case"fullscreen":return void y(t.target.closest(".canvas-container"));default:return}x(p)}))}}disconnectedCallback(){}adoptedCallback(){}attributeChangedCallback(t,e,n){}}customElements.define("mandelbrot-widget",t)})();